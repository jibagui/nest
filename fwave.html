<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>실시간 합성파 생성기</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 940px;
      margin: 30px auto 60px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      padding: 32px 28px 32px 28px;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 20px;
    }
    .btn-row {
      margin-bottom: 16px;
    }
    button {
      background: #2196f3;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 18px;
      font-size: 1rem;
      margin-right: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    button:active { background: #1769aa; }
    button.off { background: #bbb; color: #333; }
    button.del { background: #f44336; }
    button.del:active { background: #b71c1c; }
    .osc-row, .sample-osc-row {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-bottom: 6px;
      padding: 4px 4px 4px 0;
      border-radius: 5px;
      transition: background 0.2s;
    }
    .osc-row label, .sample-osc-row label {
      font-size: 0.98rem;
      margin-right: 2px;
    }
    .osc-row input[type="number"],
    .sample-osc-row input[type="number"] {
      width: 60px;
      font-size: 1rem;
      padding: 2px 4px;
      border: 1px solid #bbb;
      border-radius: 4px;
      outline: none;
      margin-right: 2px;
    }
    .osc-row input[type="range"],
    .sample-osc-row input[type="range"] {
      width: 90px;
      margin-right: 2px;
      vertical-align: middle;
      accent-color: #2196f3;
      touch-action: none;
    }
    .osc-btn, .sample-osc-btn {
      padding: 2px 10px;
      font-size: 0.96rem;
      border-radius: 4px;
      border: none;
      margin-right: 2px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .osc-btn.on, .sample-osc-btn.on { background: #2196f3; color: #fff; }
    .osc-btn.off, .sample-osc-btn.off { background: #bbb; color: #333; }
    .osc-btn.del, .sample-osc-btn.del { background: #f44336; color: #fff; }
    .osc-btn.del:active, .sample-osc-btn.del:active { background: #b71c1c; }
    .formula {
      margin-left: 8px;
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      font-size: 0.95rem;
      color: #666;
    }
    #osc-list, #sample-osc-list {
      margin-bottom: 20px;
    }
    canvas {
      display: block;
      margin: 18px 0 8px 0;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    /* 모달 스타일 */
    #osc-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18);
      align-items: center;
      justify-content: center;
    }
    #osc-modal-inner {
      background: #fff;
      border-radius: 10px;
      padding: 28px 32px 20px 32px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.20);
      min-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #osc-modal-inner label {
      margin: 8px 0 4px 0;
      font-size: 1.03rem;
    }
    #osc-modal-inner input[type="number"] {
      width: 100px;
      font-size: 1.07rem;
      padding: 3px 6px;
      margin-bottom: 6px;
      border: 1px solid #bbb;
      border-radius: 4px;
    }
    #osc-modal-inner .modal-btn-row {
      margin-top: 18px;
      width: 100%;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    /* 반응형 */
    @media (max-width: 600px) {
      .container { padding: 8px 2vw; }
      canvas { width: 98vw !important; }
      #osc-modal-inner { min-width: 90vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>실시간 합성파 생성기</h1>
    <div class="btn-row">
      <button id="add-btn">함수 추가</button>
      <button id="rand-btn">무작위 함수</button>
      <button id="reset-btn">초기화</button>
      <button id="nc-btn">노이즈 캔슬링 OFF</button>
    </div>
    <div id="osc-list"></div>
    <canvas id="waveform" width="800" height="280"></canvas>
    <hr style="margin:32px 0 20px 0;">
    <div class="btn-row">
      <button id="sample-add-btn">함수 추가</button>
      <button id="sample-rand-btn">무작위 함수</button>
      <button id="sample-reset-btn">초기화</button>
      <button id="sample-nc-btn">노이즈 캔슬링 OFF</button>
    </div>
    <div id="sample-osc-list"></div>
    <canvas id="sample-waveform" width="800" height="180"></canvas>
  </div>
  <!-- 오실레이터 추가 모달 -->
  <div id="osc-modal">
    <div id="osc-modal-inner">
      <h3 style="margin:0 0 10px 0;">함수 추가</h3>
      <label for="osc-modal-freq">주파수 (Hz):</label>
      <input type="number" id="osc-modal-freq" min="20" max="2000" step="1" value="440">
      <label for="osc-modal-vol">진폭 (0~1):</label>
      <input type="number" id="osc-modal-vol" min="0" max="1" step="0.01" value="0.5">
      <label for="osc-modal-phase">위상 (도):</label>
      <input type="number" id="osc-modal-phase" min="0" max="360" step="1" value="0">
      <div class="modal-btn-row">
        <button id="osc-modal-ok">확인</button>
        <button id="osc-modal-cancel">취소</button>
      </div>
    </div>
  </div>
  <script>
    // ===================== (1/4) UI 텍스트/모달/슬라이더 최적화 준비 =====================
    // 전역 변수 선언
    let oscillators = [];
    let sampleOscillators = [];
    let noiseCancelOn = false;
    let sampleNoiseCancelOn = false;
    const view = { tStart: 0, tSpan: 0.01, yMin: -2, yMax: 2 };
    const sampleView = { tStart: 0, tSpan: 0.01, yMin: -2, yMax: 2 };

    // 유틸리티 함수
    function randomFreq() { return Math.round(40 + Math.random()*900); }
    function randomVol() { return Math.round((0.2 + Math.random()*0.8)*100)/100; }
    function randomPhase() { return Math.round(Math.random()*360); }
    function randomColor() {
      const h = Math.floor(Math.random()*360);
      return `hsl(${h}, 80%, 55%)`;
    }
    function phaseToPiString(deg) {
      if (!deg) return '';
      if (deg === 180) return '+π';
      if (deg === 90) return '+π/2';
      if (deg === 270) return '+3π/2';
      if (deg % 180 === 0) return `+${deg/180}π`;
      if (deg % 90 === 0) return `+${deg/90}π/2`;
      return `+${(deg/180).toFixed(2)}π`;
    }

    document.addEventListener('DOMContentLoaded', function() {
      // [1-1] 버튼 이름 변경
      document.getElementById('add-btn').textContent = '함수 추가';
      document.getElementById('rand-btn').textContent = '무작위 함수';
      document.getElementById('sample-add-btn').textContent = '함수 추가';
      document.getElementById('sample-rand-btn').textContent = '무작위 함수';

      // [1-2] 오실레이터 추가 시 모달 입력창 띄우기
      function showOscModal(onOk) {
        const modal = document.getElementById('osc-modal');
        modal.style.display = 'flex';
        document.getElementById('osc-modal-freq').value = 440;
        document.getElementById('osc-modal-vol').value = 0.5;
        document.getElementById('osc-modal-phase').value = 0;
        function okHandler() {
          modal.style.display = 'none';
          onOk({
            freq: parseFloat(document.getElementById('osc-modal-freq').value),
            vol: parseFloat(document.getElementById('osc-modal-vol').value),
            phase: parseFloat(document.getElementById('osc-modal-phase').value)
          });
          cleanup();
        }
        function cancelHandler() {
          modal.style.display = 'none';
          cleanup();
        }
        function cleanup() {
          okBtn.removeEventListener('click', okHandler);
          cancelBtn.removeEventListener('click', cancelHandler);
        }
        const okBtn = document.getElementById('osc-modal-ok');
        const cancelBtn = document.getElementById('osc-modal-cancel');
        okBtn.addEventListener('click', okHandler);
        cancelBtn.addEventListener('click', cancelHandler);
        // 엔터키로 확인
        modal.querySelectorAll('input').forEach(inp => {
          inp.onkeydown = e => { if (e.key === 'Enter') okHandler(); };
        });
        document.getElementById('osc-modal-freq').focus();
      }

      // [1-3] '함수 추가' 버튼 클릭 시 모달로 값 입력받고 오실레이터 추가
      document.getElementById('add-btn').onclick = function() {
        showOscModal(function(val) {
          addOscillator(val.freq, val.vol, val.phase);
        });
      };
      document.getElementById('sample-add-btn').onclick = function() {
        showOscModal(function(val) {
          addSampleOscillator(val.freq, val.vol, val.phase);
        });
      };

      // [1-4] '무작위 함수' 버튼도 모달 없이 랜덤 값으로 추가
      document.getElementById('rand-btn').onclick = function() {
        addOscillator(randomFreq(), randomVol(), randomPhase());
      };
      document.getElementById('sample-rand-btn').onclick = function() {
        addSampleOscillator(randomFreq(), randomVol(), randomPhase());
      };

      // [1-5] 모달 외부 클릭 시 닫기
      document.getElementById('osc-modal').addEventListener('mousedown', function(e) {
        if (e.target === this) this.style.display = 'none';
      });
    });

    // ===================== (2/4) 슬라이더 실시간 적용/입력창 자동닫힘/오실레이터 추가 =====================
    function addOscillator(freq, vol, phase) {
      oscillators.push({
        freq: freq,
        vol: vol,
        phase: phase,
        color: randomColor(),
        active: true
      });
      renderOscillatorList();
      draw();
    }
    function addSampleOscillator(freq, vol, phase) {
      sampleOscillators.push({
        freq: freq,
        vol: vol,
        phase: phase,
        color: randomColor(),
        active: true
      });
      renderSampleOscillatorList();
      sampleDrawLoop();
    }

    function makeSliderHandler(list, idx, key, render, draw) {
      return function(e) {
        let val = parseFloat(e.target.value);
        list[idx][key] = val;
        render();
        draw();
      };
    }
    function makeNumberInputHandler(list, idx, key, render, draw) {
      return function(e) {
        let val = parseFloat(e.target.value);
        if (!isNaN(val)) {
          list[idx][key] = val;
          render();
          draw();
          e.target.focus();
          let len = e.target.value.length;
          e.target.setSelectionRange(len, len);
        }
      };
    }

    function renderOscillatorList() {
      const listDiv = document.getElementById('osc-list');
      listDiv.innerHTML = '';
      oscillators.forEach((osc, idx) => {
        const row = document.createElement('div');
        row.className = 'osc-row';
        row.style.background = osc.active ? '#fff' : '#eee';
        row.innerHTML = `
          <label>f:<input type="number" min="20" max="2000" step="1" value="${osc.freq}"></label>
          <input type="range" min="20" max="2000" step="1" value="${osc.freq}">
          <label>A:<input type="number" min="0" max="1" step="0.01" value="${osc.vol}"></label>
          <input type="range" min="0" max="1" step="0.01" value="${osc.vol}">
          <label>φ:<input type="number" min="0" max="360" step="1" value="${osc.phase}"></label>
          <input type="range" min="0" max="360" step="1" value="${osc.phase}">
          <button class="osc-btn ${osc.active ? 'on' : 'off'}">${osc.active ? 'ON' : 'OFF'}</button>
          <button class="osc-btn del">삭제</button>
          <span class="formula">${osc.vol}·sin(2π·${osc.freq}t${osc.phase ? `+${phaseToPiString(osc.phase)}` : ''})</span>
        `;
        const inputs = row.querySelectorAll('input[type="number"]');
        const sliders = row.querySelectorAll('input[type="range"]');
        inputs[0].addEventListener('input', makeNumberInputHandler(oscillators, idx, 'freq', renderOscillatorList, draw));
        sliders[0].addEventListener('input', makeSliderHandler(oscillators, idx, 'freq', renderOscillatorList, draw));
        inputs[1].addEventListener('input', makeNumberInputHandler(oscillators, idx, 'vol', renderOscillatorList, draw));
        sliders[1].addEventListener('input', makeSliderHandler(oscillators, idx, 'vol', renderOscillatorList, draw));
        inputs[2].addEventListener('input', makeNumberInputHandler(oscillators, idx, 'phase', renderOscillatorList, draw));
        sliders[2].addEventListener('input', makeSliderHandler(oscillators, idx, 'phase', renderOscillatorList, draw));
        row.querySelector('.osc-btn.on, .osc-btn.off').onclick = function() {
          oscillators[idx].active = !oscillators[idx].active;
          renderOscillatorList();
          draw();
        };
        row.querySelector('.osc-btn.del').onclick = function() {
          oscillators.splice(idx, 1);
          renderOscillatorList();
          draw();
        };
        listDiv.appendChild(row);
      });
    }

    function renderSampleOscillatorList() {
      const listDiv = document.getElementById('sample-osc-list');
      listDiv.innerHTML = '';
      sampleOscillators.forEach((osc, idx) => {
        const row = document.createElement('div');
        row.className = 'sample-osc-row';
        row.style.background = osc.active ? '#fff' : '#eee';
        row.innerHTML = `
          <label>f:<input type="number" min="20" max="2000" step="1" value="${osc.freq}"></label>
          <input type="range" min="20" max="2000" step="1" value="${osc.freq}">
          <label>A:<input type="number" min="0" max="1" step="0.01" value="${osc.vol}"></label>
          <input type="range" min="0" max="1" step="0.01" value="${osc.vol}">
          <label>φ:<input type="number" min="0" max="360" step="1" value="${osc.phase}"></label>
          <input type="range" min="0" max="360" step="1" value="${osc.phase}">
          <button class="sample-osc-btn ${osc.active ? 'on' : 'off'}">${osc.active ? 'ON' : 'OFF'}</button>
          <button class="sample-osc-btn del">삭제</button>
          <span class="formula">${osc.vol}·sin(2π·${osc.freq}t${osc.phase ? `+${phaseToPiString(osc.phase)}` : ''})</span>
        `;
        const inputs = row.querySelectorAll('input[type="number"]');
        const sliders = row.querySelectorAll('input[type="range"]');
        inputs[0].addEventListener('input', makeNumberInputHandler(sampleOscillators, idx, 'freq', renderSampleOscillatorList, sampleDrawLoop));
        sliders[0].addEventListener('input', makeSliderHandler(sampleOscillators, idx, 'freq', renderSampleOscillatorList, sampleDrawLoop));
        inputs[1].addEventListener('input', makeNumberInputHandler(sampleOscillators, idx, 'vol', renderSampleOscillatorList, sampleDrawLoop));
        sliders[1].addEventListener('input', makeSliderHandler(sampleOscillators, idx, 'vol', renderSampleOscillatorList, sampleDrawLoop));
        inputs[2].addEventListener('input', makeNumberInputHandler(sampleOscillators, idx, 'phase', renderSampleOscillatorList, sampleDrawLoop));
        sliders[2].addEventListener('input', makeSliderHandler(sampleOscillators, idx, 'phase', renderSampleOscillatorList, sampleDrawLoop));
        row.querySelector('.sample-osc-btn.on, .sample-osc-btn.off').onclick = function() {
          sampleOscillators[idx].active = !sampleOscillators[idx].active;
          renderSampleOscillatorList();
          sampleDrawLoop();
        };
        row.querySelector('.sample-osc-btn.del').onclick = function() {
          sampleOscillators.splice(idx, 1);
          renderSampleOscillatorList();
          sampleDrawLoop();
        };
        listDiv.appendChild(row);
      });
    }

    // ===================== (3/4) 파형 그리기(draw), 오실레이터 리스트 초기화, 버튼 연결 =====================
    function drawGrid(ctx, width, height, vstep, hstep) {
      ctx.save();
      ctx.strokeStyle = "#eee";
      ctx.lineWidth = 1;
      for (let x = 40; x < width-10; x += Math.round((width-60)/vstep)) {
        ctx.beginPath();
        ctx.moveTo(x, 10);
        ctx.lineTo(x, height-10);
        ctx.stroke();
      }
      for (let y = 10; y < height-10; y += Math.round((height-20)/hstep)) {
        ctx.beginPath();
        ctx.moveTo(40, y);
        ctx.lineTo(width-10, y);
        ctx.stroke();
      }
      ctx.restore();
    }
    function drawAxes(ctx, width, height, yMin, yMax, view) {
      ctx.save();
      ctx.strokeStyle = "#bbb";
      ctx.lineWidth = 1.2;
      // x축
      let y0 = height/2 - (0)*((height-40)/(yMax-yMin));
      ctx.beginPath();
      ctx.moveTo(40, y0);
      ctx.lineTo(width-10, y0);
      ctx.stroke();
      // y축
      ctx.beginPath();
      ctx.moveTo(40, 10);
      ctx.lineTo(40, height-10);
      ctx.stroke();
      ctx.restore();
    }

    function draw() {
      const canvas = document.getElementById('waveform');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawGrid(ctx, canvas.width, canvas.height, 10, 8);
      const n = 800;
      const t = Array.from({length:n}, (_,i)=>view.tStart + i/n*view.tSpan);
      let sum = Array(n).fill(0);
      oscillators.forEach((o) => {
        if(o.active) {
          const phi = o.phase * Math.PI / 180;
          for(let i=0; i<n; i++) {
            sum[i] += Math.sin(2*Math.PI*o.freq*t[i] + phi) * o.vol;
          }
        }
      });
      drawAxes(ctx, canvas.width, canvas.height, view.yMin, view.yMax, view);
      ctx.save();
      ctx.beginPath();
      for(let i=0; i<n; i++) {
        const x = 40 + (canvas.width-60)*(t[i]-view.tStart)/view.tSpan;
        const y = canvas.height/2 - (sum[i])*((canvas.height-40)/(view.yMax-view.yMin));
        if(i===0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#2196f3";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.95;
      ctx.stroke();
      ctx.restore();
    }

    function sampleDrawLoop() {
      const canvas = document.getElementById('sample-waveform');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawGrid(ctx, canvas.width, canvas.height, 10, 8);
      const n = 800;
      const t = Array.from({length:n}, (_,i)=>sampleView.tStart + i/n*sampleView.tSpan);
      let sum = Array(n).fill(0);
      sampleOscillators.forEach((o) => {
        if(o.active) {
          const phi = o.phase * Math.PI / 180;
          for(let i=0; i<n; i++) {
            sum[i] += Math.sin(2*Math.PI*o.freq*t[i] + phi) * o.vol;
          }
        }
      });
      drawAxes(ctx, canvas.width, canvas.height, sampleView.yMin, sampleView.yMax, sampleView);
      ctx.save();
      ctx.beginPath();
      for(let i=0; i<n; i++) {
        const x = 40 + (canvas.width-60)*(t[i]-sampleView.tStart)/sampleView.tSpan;
        const y = canvas.height/2 - (sum[i])*((canvas.height-40)/(sampleView.yMax-sampleView.yMin));
        if(i===0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.strokeStyle = "#4caf50";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 0.95;
      ctx.stroke();
      ctx.restore();
    }

    document.addEventListener('DOMContentLoaded', function() {
      renderOscillatorList();
      renderSampleOscillatorList();
      draw();
      sampleDrawLoop();
    });

    document.getElementById('reset-btn').onclick = function() {
      oscillators = [];
      renderOscillatorList();
      draw();
    };
    document.getElementById('sample-reset-btn').onclick = function() {
      sampleOscillators = [];
      renderSampleOscillatorList();
      sampleDrawLoop();
    };
    document.getElementById('nc-btn').onclick = function() {
      noiseCancelOn = !noiseCancelOn;
      this.textContent = noiseCancelOn ? '노이즈 캔슬링 ON' : '노이즈 캔슬링 OFF';
      this.classList.toggle('active', noiseCancelOn);
      draw();
    };
    document.getElementById('sample-nc-btn').onclick = function() {
      sampleNoiseCancelOn = !sampleNoiseCancelOn;
      this.textContent = sampleNoiseCancelOn ? '노이즈 캔슬링 ON' : '노이즈 캔슬링 OFF';
      this.classList.toggle('active', sampleNoiseCancelOn);
      sampleDrawLoop();
    };
  </script>
</body>
</html>
