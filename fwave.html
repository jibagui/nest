<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>실시간 합성파 생성기</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    #controls, #sample-controls { background: #fff; padding: 20px; border-bottom: 1px solid #ddd; }
    #osc-list, #sample-osc-list { margin-bottom: 10px; }
    .osc-row, .sample-osc-row { margin-bottom: 8px; }
    .osc-row input[type="number"], .sample-osc-row input[type="number"] { width: 70px; }
    .osc-row input[type="range"], .sample-osc-row input[type="range"] {
      width: 120px; margin: 0 8px; vertical-align: middle;
      will-change: transform;
      height: 18px; /* 슬라이더 높이 증가 */
      border-radius: 9px;
      background: #e3e3e3;
      accent-color: #2196f3;
    }
    .osc-row label, .sample-osc-row label { margin-right: 5px; }
    .osc-row button, .sample-osc-row button { margin-left: 10px; }
    .osc-btn, .sample-osc-btn {
      display: inline-block;
      min-width: 60px;
      min-height: 36px;
      padding: 0 16px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      margin-left: 10px;
      vertical-align: middle;
      cursor: pointer;
      transition: background 0.15s;
    }
    .on { background: #4caf50; color: #fff; }
    .off { background: #eee; color: #444; }
    .del { background: #e53935; color: #fff; }
    #play-btn, #restart-btn, #sample-play-btn, #back-btn, .osc-util-btn {
      font-size: 1.2em; padding: 0.7em 2em; border: none; border-radius: 8px;
      background: #2196f3; color: #fff; margin-bottom: 1em; cursor: pointer;
      margin-right: 1em;
    }
    #restart-btn { background: #ffa726; color: #fff; margin-left: 0; }
    .osc-util-btn { background: #eee; color: #222; font-size: 1em; margin-right: 0.7em; }
    .osc-util-btn.active { background: #ff9800; color: #fff; }
    .osc-util-btn:disabled,
    .osc-util-btn.disabled {
      background: #bbb !important;
      color: #fff !important;
      cursor: not-allowed !important;
      opacity: 1 !important;
    }
    .formula {
      font-size: 1em;
      margin-left: 1.5em;
      color: #333;
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      background: #f6f6f6;
      border-radius: 6px;
      padding: 2px 8px;
      display: inline-block;
    }
    #canvas-wrap, #sample-canvas-wrap {
      text-align: center;
      margin: 0 auto;
      background: #fff;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
      position: relative;
    }
    canvas {
      border: 1px solid #bbb;
      background: #fafafa;
      margin: 20px auto;
      display: block;
      touch-action: none;
    }
    #sample-buttons {
      display: flex; gap: 20px; justify-content: center; margin: 36px 0 24px 0;
    }
    .wave-btn {
      border: 2px solid #aaa; border-radius: 12px; background: #fff; cursor: pointer;
      width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 2px 8px #0001; transition: box-shadow .2s;
    }
    .wave-btn:hover { box-shadow: 0 4px 16px #0002; border-color: #2196f3; }
    .wave-btn svg { width: 80px; height: 40px; margin-bottom: 8px; }
    .wave-btn span { font-size: 1.1em; margin-top: 2px; }
    .wave-btn svg polyline { stroke-width: 4 !important; }
    #sample-controls, #sample-canvas-wrap {
      visibility: hidden; position: absolute; left: -9999px;
    }
    #controls, #canvas-wrap, #sample-buttons {
      visibility: visible; position: static;
    }
    .show-sample #sample-controls, .show-sample #sample-canvas-wrap {
      visibility: visible !important; position: static !important;
    }
    .show-sample #controls, .show-sample #canvas-wrap, #sample-buttons {
      visibility: hidden !important; position: absolute !important; left: -9999px !important;
    }
    #sample-osc-list { margin-top: 8px; }
    #back-btn { background: #888; color: #fff; margin-left: 0; }
    .sample-formula-math {
      background: #f6f6f6;
      border-radius: 8px;
      padding: 18px 18px 12px 18px;
      margin: 16px auto 10px auto;
      font-size: 1.15em;
      max-width: 98vw;
      box-sizing: border-box;
      overflow-x: auto;
      white-space: nowrap;
      text-align: left;
    }
    .sample-formula-math h3 {
      margin: 0 0 8px 0;
      font-size: 1.12em;
      font-weight: bold;
      color: #333;
    }
    .mjx-container[jax="CHTML"] {
      overflow-x: auto !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }
    input[type="range"] { touch-action: none; }
    #osc-modal {
      display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: #0006; z-index: 1000; align-items: center; justify-content: center;
    }
    #osc-modal > div {
      background: #fff; padding: 24px 32px; border-radius: 16px; min-width: 260px;
      box-shadow: 0 4px 24px #0003;
    }
    #osc-modal input[type="number"] { width: 80px; margin-left: 8px; }
    #osc-modal label { display: block; margin: 8px 0 0 0; }
    #osc-modal button { margin-left: 10px; margin-top: 10px; }
  </style>
  <script>
    window.MathJax = {
      tex: { displayMath: [['$$','$$'], ['\\[','\\]']] },
      options: { renderActions: { addMenu: [] } },
      chtml: {
        displayAlign: 'center',
        displayIndent: '0',
        scale: 1,
        linebreaks: { automatic: false }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div id="controls">
    <button id="play-btn">▶ 재생</button>
    <button id="restart-btn" title="처음부터 재생">⟲</button>
    <div id="osc-list"></div>
    <div id="osc-btns">
      <button id="add-btn" class="osc-util-btn">함수 추가</button>
      <button id="rand-btn" class="osc-util-btn">무작위 함수</button>
      <button id="nc-btn" class="osc-util-btn">노이즈 캔슬링 OFF</button>
      <button id="reset-btn" class="osc-util-btn">초기화</button>
    </div>
  </div>
  <div id="canvas-wrap">
    <canvas id="waveform" width="820" height="340"></canvas>
  </div>
  <div id="sample-buttons">
    <button class="wave-btn" id="btn-tri">
      <svg viewBox="0 0 80 40">
        <polyline points="0,20 20,0 40,20 60,40 80,20" fill="none" stroke="#2196f3"/>
      </svg>
      <span>Triangle</span>
    </button>
    <button class="wave-btn" id="btn-square">
      <svg viewBox="0 0 80 40">
        <polyline points="0,40 0,0 40,0 40,40 80,40 80,0" fill="none" stroke="#e91e63"/>
      </svg>
      <span>Square</span>
    </button>
    <button class="wave-btn" id="btn-saw">
      <svg viewBox="0 0 80 40">
        <polyline points="0,40 80,0 80,40" fill="none" stroke="#4caf50"/>
      </svg>
      <span>Sawtooth</span>
    </button>
  </div>
  <div id="sample-controls">
    <button id="sample-play-btn">▶ 재생</button>
    <button id="back-btn">← 뒤로가기</button>
    <div id="sample-formula" class="sample-formula-math"></div>
    <div id="sample-osc-list"></div>
    <div id="sample-osc-btns">
      <button id="sample-add-btn" class="osc-util-btn">함수 추가</button>
      <button id="sample-rand-btn" class="osc-util-btn">무작위 함수</button>
      <button id="sample-nc-btn" class="osc-util-btn">노이즈 캔슬링 OFF</button>
      <button id="sample-reset-btn" class="osc-util-btn">초기화</button>
    </div>
  </div>
  <div id="sample-canvas-wrap">
    <canvas id="sample-waveform" width="820" height="340"></canvas>
  </div>
  <div id="osc-modal">
    <div>
      <h3>오실레이터 추가</h3>
      <label>주파수(Hz): <input id="osc-modal-freq" type="number" value="440" min="20" max="2000"></label>
      <label>볼륨(A): <input id="osc-modal-vol" type="number" value="0.5" min="0" max="1" step="0.01"></label>
      <label>위상(°): <input id="osc-modal-phase" type="number" value="0" min="0" max="360"></label>
      <div style="margin-top:16px;text-align:right;">
        <button id="osc-modal-cancel">취소</button>
        <button id="osc-modal-ok">추가</button>
      </div>
    </div>
  </div>
<script>
// ===================== 유틸리티 및 전역 변수 =====================
function randomColor(alpha=0.35) {
  const r = Math.floor(Math.random()*200+30);
  const g = Math.floor(Math.random()*200+30);
  const b = Math.floor(Math.random()*200+30);
  return `rgba(${r},${g},${b},${alpha})`;
}
function randomFreq() { return Math.round(Math.pow(2, Math.random()*6 + Math.log2(60))); }
function randomVol() { return +(Math.random()).toFixed(2); }
function randomPhase() { return Math.floor(Math.random()*360); }
function phaseToPiString(deg) {
  deg = ((deg % 360) + 360) % 360;
  if (deg === 0) return '0';
  if (deg === 180) return 'π';
  if (deg === 90) return 'π/2';
  if (deg === 270) return '3π/2';
  let frac = +(deg / 180).toFixed(2);
  return `${frac}π`;
}

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let oscillators = [];
let isPlaying = false;
let noiseCancelOn = false;
let workletNode = null;
let workletReady = false;

let sampleOscillators = [];
let sampleIsPlaying = false;
let sampleWorkletNode = null;
let sampleWorkletReady = false;
let sampleIsPlayingFlag = false;
let sampleNoiseCancelOn = false;
let sampleNoiseCancelOscIdxs = [];
let sampleOscillatorsState = {};
let sampleWaveType = '';
let sampleBaseFreq = 440;
let sampleDrawRequest = null;

let view = { tStart: 0, tSpan: 0.02, dragging: false, dragStartX: 0, dragStartT: 0, pinchStartDist: 0, pinchStartSpan: 0 };
let sampleView = { tStart: 0, tSpan: 0.02, dragging: false, dragStartX: 0, dragStartT: 0, pinchStartDist: 0, pinchStartSpan: 0 };

let playHead = { t: 0 };
let marker = { t: 0.005 };
let samplePlayHead = { t: 0 };
let sampleMarker = { t: 0.005 };

// ===================== 샘플파 정의 =====================
const sampleDefs = {
  'triangle': {
    name: '삼각파 (Triangle Wave)',
    color: '#2196f3',
    N: 9,
    formulaLatex: `
<h3>삼각파 (Triangle Wave)</h3>
$$
f_{\\text{triangle}}(t) = \\frac{8}{\\pi^2} \\left[
    \\sin(2\\pi f t)
    - \\frac{1}{9} \\sin(2\\pi \\cdot 3f t)
    + \\frac{1}{25} \\sin(2\\pi \\cdot 5f t)
    - \\frac{1}{49} \\sin(2\\pi \\cdot 7f t)
    + \\frac{1}{81} \\sin(2\\pi \\cdot 9f t)
\\right]
$$
`,
    harmonics: (f) => {
      let arr = [];
      for(let n=1;n<=9;n+=2) {
        let amp = 8/(Math.PI*Math.PI)/n/n*(n%4===1?1:-1);
        arr.push({freq: n*f, amp: Math.abs(amp), phase: amp>0?0:180, color: '#2196f3'});
      }
      return arr;
    }
  },
  'square': {
    name: '사각파 (Square Wave)',
    color: '#e91e63',
    N: 9,
    formulaLatex: `
<h3>사각파 (Square Wave)</h3>
$$
f_{\\text{square}}(t) = \\frac{4}{\\pi} \\left[
    \\sin(2\\pi f t)
    + \\frac{1}{3} \\sin(2\\pi \\cdot 3f t)
    + \\frac{1}{5} \\sin(2\\pi \\cdot 5f t)
    + \\frac{1}{7} \\sin(2\\pi \\cdot 7f t)
    + \\frac{1}{9} \\sin(2\\pi \\cdot 9f t)
\\right]
$$
`,
    harmonics: (f) => {
      let arr = [];
      for(let n=1;n<=9;n+=2) {
        let amp = 4/(Math.PI*n);
        arr.push({freq: n*f, amp: Math.abs(amp), phase: amp>0?0:180, color: '#e91e63'});
      }
      return arr;
    }
  },
  'saw': {
    name: '톱니파 (Sawtooth Wave)',
    color: '#4caf50',
    N: 9,
    formulaLatex: `
<h3>톱니파 (Sawtooth Wave)</h3>
$$
f_{\\text{sawtooth}}(t) = \\frac{2}{\\pi} \\left[
    \\sin(2\\pi f t)
    - \\frac{1}{2} \\sin(2\\pi \\cdot 2f t)
    + \\frac{1}{3} \\sin(2\\pi \\cdot 3f t)
    - \\frac{1}{4} \\sin(2\\pi \\cdot 4f t)
    + \\frac{1}{5} \\sin(2\\pi \\cdot 5f t)
    - \\frac{1}{6} \\sin(2\\pi \\cdot 6f t)
    + \\frac{1}{7} \\sin(2\\pi \\cdot 7f t)
    - \\frac{1}{8} \\sin(2\\pi \\cdot 8f t)
    + \\frac{1}{9} \\sin(2\\pi \\cdot 9f t)
\\right]
$$
`,
    harmonics: (f) => {
      let arr = [];
      for(let n=1;n<=9;n++) {
        let amp = 2/(Math.PI*n)*(n%2===0?-1:1);
        arr.push({freq: n*f, amp: Math.abs(amp), phase: amp>0?0:180, color: '#4caf50'});
      }
      return arr;
    }
  }
};

// ===================== (2/3에서 계속) =====================
// (2/3에서 상하 확대, 시점 이동, seek bar 추가 예정)
// ===================== (2/3) 상하 확대/축소, 시점 이동, 상단 seek bar =====================

// 1. view와 sampleView에 yMin, yMax 추가 (초기값)
view.yMin = -1;
view.yMax = 1;
sampleView.yMin = -1;
sampleView.yMax = 1;

// 2. 캔버스 상하 확대/축소 (shift+wheel)
function setupYZoom(canvas, viewObj, redrawFunc) {
  canvas.addEventListener('wheel', e => {
    if (e.shiftKey) {
      e.preventDefault();
      let span = viewObj.yMax - viewObj.yMin;
      let center = (viewObj.yMax + viewObj.yMin) / 2;
      let scale = e.deltaY > 0 ? 1.15 : 0.87;
      span *= scale;
      // 최소/최대 y축 범위 제한
      span = Math.max(0.1, Math.min(10, span));
      viewObj.yMin = center - span/2;
      viewObj.yMax = center + span/2;
      redrawFunc();
    }
  }, {passive:false});
}
setupYZoom(document.getElementById('waveform'), view, draw);
setupYZoom(document.getElementById('sample-waveform'), sampleView, sampleDrawLoop);

// 3. drawAxes 함수에서 yMin, yMax를 view에서 받아오도록 수정
function drawAxes(ctx, width, height, yMin, yMax, viewObj) {
  ctx.save();
  ctx.strokeStyle = "#888";
  ctx.lineWidth = 1;
  ctx.font = "12px sans-serif";
  ctx.fillStyle = "#888";
  ctx.globalAlpha = 1;

  ctx.beginPath();
  ctx.moveTo(40, height/2);
  ctx.lineTo(width-10, height/2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(40, 10);
  ctx.lineTo(40, height-10);
  ctx.stroke();

  // x축 ms 눈금: tStart에 따라 이동
  let msStart = Math.round(viewObj.tStart * 1000);
  let msSpan = Math.round(viewObj.tSpan * 1000);
  let step = 5;
  let msEnd = msStart + msSpan;
  for(let ms = Math.ceil(msStart/step)*step; ms <= msEnd; ms += step) {
    let t = ms/1000;
    let x = 40 + (width-60)*(t-viewObj.tStart)/viewObj.tSpan;
    ctx.beginPath();
    ctx.moveTo(x, height/2-5);
    ctx.lineTo(x, height/2+5);
    ctx.stroke();
    ctx.fillText(`${ms}ms`, x-12, height/2+20);
  }

  // y축 눈금
  let range = yMax - yMin;
  let idealSteps = Math.floor((height-40)/32);
  let ystep = Math.pow(10, Math.floor(Math.log10(range)));
  let bestStep = ystep;
  let bestCount = 1000;
  [1,2,5].forEach(f=>{
    let s = f*ystep;
    let cnt = Math.ceil(range/s);
    if(cnt<=idealSteps && cnt>1 && Math.abs(cnt-idealSteps)<Math.abs(bestCount-idealSteps)) {
      bestStep = s;
      bestCount = cnt;
    }
  });
  ystep = bestStep;
  let yStart = Math.ceil(yMin/ystep)*ystep;
  let yEnd = Math.floor(yMax/ystep)*ystep;
  let ticks = [];
  for(let a=yStart; a<=yEnd+ystep/2; a+=ystep) {
    ticks.push(a);
  }
  function closeTo(a, b) { return Math.abs(a-b)<ystep/100; }
  if (!ticks.some(v=>closeTo(v,yMin))) ticks.push(yMin);
  if (!ticks.some(v=>closeTo(v,yMax))) ticks.push(yMax);
  ticks = Array.from(new Set(ticks.map(v=>+v.toFixed(8)))).sort((a,b)=>b-a);
  for(let i=0; i<ticks.length; ++i) {
    let a = ticks[i];
    let y = height/2 - (a-((yMax+yMin)/2))*(height-40)/range;
    ctx.beginPath();
    ctx.moveTo(35, y);
    ctx.lineTo(45, y);
    ctx.stroke();
    ctx.fillText(a.toFixed(2), 10, y+4);
  }
  ctx.restore();
}

// 4. draw 함수에서 drawAxes 호출부 수정
function draw() {
  const canvas = document.getElementById('waveform');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid(ctx, canvas.width, canvas.height, 10, 8);
  const n = 800;
  const t = Array.from({length:n}, (_,i)=>view.tStart + i/n*view.tSpan);
  let sum = Array(n).fill(0);
  let yMax = -Infinity, yMin = Infinity;
  oscillators.forEach((o,idx)=>{
    if(o.active) {
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        sum[i] += y;
      }
    }
  });
  for(let i=0; i<n; i++) {
    if(sum[i] > yMax) yMax = sum[i];
    if(sum[i] < yMin) yMin = sum[i];
  }
  // y축 범위는 view.yMin/yMax 우선 사용
  yMax = view.yMax;
  yMin = view.yMin;
  drawAxes(ctx, canvas.width, canvas.height, yMin, yMax, view);
  // ... 이하 기존 draw 코드 동일 ...
  // (3/3에서 계속)
}

// 5. sampleDrawLoop도 동일하게 drawAxes 호출부 수정
function sampleDrawLoop() {
  const canvas = document.getElementById('sample-waveform');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid(ctx, canvas.width, canvas.height, 10, 8);

  const n = 800;
  const t = Array.from({length:n}, (_,i)=>sampleView.tStart + i/n*sampleView.tSpan);
  let sum = Array(n).fill(0);
  let yMax = -Infinity, yMin = Infinity;
  sampleOscillators.forEach((o,idx)=>{
    if(o.active) {
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        sum[i] += y;
      }
    }
  });
  for(let i=0; i<n; i++) {
    if(sum[i] > yMax) yMax = sum[i];
    if(sum[i] < yMin) yMin = sum[i];
  }
  yMax = sampleView.yMax;
  yMin = sampleView.yMin;
  drawAxes(ctx, canvas.width, canvas.height, yMin, yMax, sampleView);
  // ... 이하 기존 sampleDrawLoop 코드 동일 ...
  // (3/3에서 계속)
}

// 6. 시점 이동(좌우 드래그) 시 view.tStart 변경 → drawAxes에서 x축 눈금도 같이 이동됨
setupCanvasInteraction(
  document.getElementById('waveform'), 
  view, 
  draw, 
  playHead, 
  marker
);
setupCanvasInteraction(
  document.getElementById('sample-waveform'), 
  sampleView, 
  sampleDrawLoop, 
  samplePlayHead, 
  sampleMarker
);

// 7. 상단 seek bar(막대) 및 클릭 이동
function drawSeekBar(ctx, width, viewObj) {
  ctx.save();
  ctx.strokeStyle = "#2196f3";
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.moveTo(40, 18);
  ctx.lineTo(width-20, 18);
  ctx.stroke();
  ctx.restore();
}

// draw, sampleDrawLoop에서 drawSeekBar 호출 추가
// drawSeekBar(ctx, canvas.width, view);

function addSeekBarClick(canvas, viewObj, playHeadObj, redrawFunc) {
  canvas.addEventListener('pointerdown', e => {
    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;
    // 상단 seek bar 클릭 시 playHead.t 이동
    if (y >= 10 && y <= 26 && x >= 40 && x <= canvas.width-20) {
      let t = viewObj.tStart + ((x-40)/(canvas.width-60))*viewObj.tSpan;
      playHeadObj.t = t;
      if (isPlaying && workletNode && canvas.id === 'waveform') workletNode.port.postMessage({type: 'seek', t});
      if (sampleIsPlaying && sampleWorkletNode && canvas.id === 'sample-waveform') sampleWorkletNode.port.postMessage({type: 'seek', t});
      redrawFunc();
      return;
    }
  });
}
addSeekBarClick(document.getElementById('waveform'), view, playHead, draw);
addSeekBarClick(document.getElementById('sample-waveform'), sampleView, samplePlayHead, sampleDrawLoop);

<script>
// ===================== (3/3) draw, sampleDrawLoop 마무리 =====================

// draw 함수에 상단 seek bar 그리기 추가
function draw() {
  const canvas = document.getElementById('waveform');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid(ctx, canvas.width, canvas.height, 10, 8);
  drawSeekBar(ctx, canvas.width, view); // 상단 seek bar
  const n = 800;
  const t = Array.from({length:n}, (_,i)=>view.tStart + i/n*view.tSpan);
  let sum = Array(n).fill(0);
  let yMax = -Infinity, yMin = Infinity;
  oscillators.forEach((o,idx)=>{
    if(o.active) {
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        sum[i] += y;
      }
    }
  });
  for(let i=0; i<n; i++) {
    if(sum[i] > yMax) yMax = sum[i];
    if(sum[i] < yMin) yMin = sum[i];
  }
  yMax = view.yMax;
  yMin = view.yMin;
  drawAxes(ctx, canvas.width, canvas.height, yMin, yMax, view);

  oscillators.forEach((o,idx)=>{
    if(o.active) {
      ctx.beginPath();
      ctx.strokeStyle = o.color || "#2196f3";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 1;
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        const px = 40 + (canvas.width-60)*(t[i]-view.tStart)/view.tSpan;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.stroke();
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        const px = 40 + (canvas.width-60)*(t[i]-view.tStart)/view.tSpan;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.lineTo(40 + (canvas.width-60), canvas.height/2);
      ctx.lineTo(40, canvas.height/2);
      ctx.closePath();
      ctx.fillStyle = o.color || "#2196f3";
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  });
  ctx.beginPath();
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 3;
  for(let i=0; i<n; i++) {
    const px = 40 + (canvas.width-60)*(t[i]-view.tStart)/view.tSpan;
    const py = canvas.height/2 - (sum[i]-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  drawPlayHead(ctx, canvas.width, canvas.height, view, playHead);
  drawMarker(ctx, canvas.width, canvas.height, view, marker);
  requestAnimationFrame(draw);
}

// sampleDrawLoop 함수에도 seek bar 그리기 추가
function sampleDrawLoop() {
  const canvas = document.getElementById('sample-waveform');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid(ctx, canvas.width, canvas.height, 10, 8);
  drawSeekBar(ctx, canvas.width, sampleView); // 상단 seek bar

  const n = 800;
  const t = Array.from({length:n}, (_,i)=>sampleView.tStart + i/n*sampleView.tSpan);
  let sum = Array(n).fill(0);
  let yMax = -Infinity, yMin = Infinity;
  sampleOscillators.forEach((o,idx)=>{
    if(o.active) {
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        sum[i] += y;
      }
    }
  });
  for(let i=0; i<n; i++) {
    if(sum[i] > yMax) yMax = sum[i];
    if(sum[i] < yMin) yMin = sum[i];
  }
  yMax = sampleView.yMax;
  yMin = sampleView.yMin;
  drawAxes(ctx, canvas.width, canvas.height, yMin, yMax, sampleView);

  sampleOscillators.forEach((o,idx)=>{
    if(o.active) {
      ctx.beginPath();
      ctx.strokeStyle = o.color || "#2196f3";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 1;
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        const px = 40 + (canvas.width-60)*(t[i]-sampleView.tStart)/sampleView.tSpan;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.stroke();
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        const px = 40 + (canvas.width-60)*(t[i]-sampleView.tStart)/sampleView.tSpan;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.lineTo(40 + (canvas.width-60), canvas.height/2);
      ctx.lineTo(40, canvas.height/2);
      ctx.closePath();
      ctx.fillStyle = o.color || "#2196f3";
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  });
  ctx.beginPath();
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 3;
  for(let i=0; i<n; i++) {
    const px = 40 + (canvas.width-60)*(t[i]-sampleView.tStart)/sampleView.tSpan;
    const py = canvas.height/2 - (sum[i]-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  drawPlayHead(ctx, canvas.width, canvas.height, sampleView, samplePlayHead, "#f00");
  drawMarker(ctx, canvas.width, canvas.height, sampleView, sampleMarker, "#0a0");
  requestAnimationFrame(sampleDrawLoop);
}

// ===================== 샘플 버튼 및 showSample 함수 =====================
['tri','square','saw'].forEach(type => {
  document.getElementById('btn-' + type).onclick = () => {
    showSample(type);
  };
});

function showSample(type) {
  // 샘플 모드로 전환
  document.body.classList.add('show-sample');
  // 샘플 정보 세팅
  sampleWaveType = type;
  sampleBaseFreq = 440;
  const def = sampleDefs[type];
  sampleOscillators = def.harmonics(sampleBaseFreq).map(o => ({
    freq: o.freq,
    amp: o.amp,
    phase: o.phase,
    active: true,
    color: o.color
  }));
  // 수식 표시
  document.getElementById('sample-formula').innerHTML = def.formulaLatex;
  MathJax.typesetPromise([document.getElementById('sample-formula')]);
  sampleView.tStart = 0;
  sampleView.tSpan = 0.02;
  sampleView.yMin = -1;
  sampleView.yMax = 1;
  samplePlayHead.t = 0;
  sampleMarker.t = 0.005;
  sampleDrawLoop();
}

document.getElementById('back-btn').onclick = () => {
  document.body.classList.remove('show-sample');
};

// ===================== 최초 렌더링 =====================
updateOscListUI();
draw();

</script>
</body>
</html>
