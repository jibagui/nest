<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>실시간 합성파 생성기</title>
<style>
  body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
  #controls, #sample-controls { background: #fff; padding: 20px; border-bottom: 1px solid #ddd; }
  #osc-list, #sample-osc-list { margin-bottom: 10px; }
  .osc-row, .sample-osc-row { margin-bottom: 8px; }
  .osc-row input[type="number"], .sample-osc-row input[type="number"] { width: 70px; }
  .osc-row input[type="range"], .sample-osc-row input[type="range"] { width: 120px; margin: 0 8px; vertical-align: middle; }
  .osc-row label, .sample-osc-row label { margin-right: 5px; }
  .osc-row button, .sample-osc-row button { margin-left: 10px; }
  .osc-btn, .sample-osc-btn {
    display: inline-block;
    min-width: 60px;
    min-height: 36px;
    padding: 0 16px;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    margin-left: 10px;
    vertical-align: middle;
    cursor: pointer;
    transition: background 0.15s;
  }
  .on { background: #4caf50; color: #fff; }
  .off { background: #eee; color: #444; }
  .del { background: #e53935; color: #fff; }
  #play-btn, #sample-play-btn, #back-btn, .osc-util-btn {
    font-size: 1.2em; padding: 0.7em 2em; border: none; border-radius: 8px;
    background: #2196f3; color: #fff; margin-bottom: 1em; cursor: pointer;
    margin-right: 1em;
  }
  .osc-util-btn { background: #eee; color: #222; font-size: 1em; margin-right: 0.7em; }
  .osc-util-btn.active { background: #ff9800; color: #fff; }
  .osc-util-btn:disabled,
  .osc-util-btn.disabled {
    background: #bbb !important;
    color: #fff !important;
    cursor: not-allowed !important;
    opacity: 1 !important;
  }
  .formula {
    font-size: 1em;
    margin-left: 1.5em;
    color: #333;
    font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
    background: #f6f6f6;
    border-radius: 6px;
    padding: 2px 8px;
    display: inline-block;
  }
  #canvas-wrap, #sample-canvas-wrap {
    text-align: center;
    margin: 0 auto;
    background: #fff;
    width: 100%;
    max-width: 900px;
    box-sizing: border-box;
  }
  canvas {
    border: 1px solid #bbb;
    background: #fafafa;
    margin: 20px auto;
    display: block;
  }
  #sample-buttons {
    display: flex; gap: 20px; justify-content: center; margin: 36px 0 24px 0;
  }
  .wave-btn {
    border: 2px solid #aaa; border-radius: 12px; background: #fff; cursor: pointer;
    width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 2px 8px #0001; transition: box-shadow .2s;
  }
  .wave-btn:hover { box-shadow: 0 4px 16px #0002; border-color: #2196f3; }
  .wave-btn svg { width: 80px; height: 40px; margin-bottom: 8px; }
  .wave-btn span { font-size: 1.1em; margin-top: 2px; }
  .wave-btn svg polyline { stroke-width: 4 !important; }
  #sample-controls, #sample-canvas-wrap {
    visibility: hidden; position: absolute; left: -9999px;
  }
  #controls, #canvas-wrap, #sample-buttons {
    visibility: visible; position: static;
  }
  .show-sample #sample-controls, .show-sample #sample-canvas-wrap {
    visibility: visible !important; position: static !important;
  }
  .show-sample #controls, .show-sample #canvas-wrap, .show-sample #sample-buttons {
    visibility: hidden !important; position: absolute !important; left: -9999px !important;
  }
  #sample-osc-list { margin-top: 8px; }
  #back-btn { background: #888; color: #fff; margin-left: 0; }
  .sample-formula-math {
    background: #f6f6f6;
    border-radius: 8px;
    padding: 18px 18px 12px 18px;
    margin: 16px auto 10px auto;
    font-size: 1.15em;
    max-width: 98vw;
    box-sizing: border-box;
    overflow-x: auto;
    white-space: nowrap;
    text-align: left;
  }
  .sample-formula-math h3 {
    margin: 0 0 8px 0;
    font-size: 1.12em;
    font-weight: bold;
    color: #333;
  }
  .mjx-container[jax="CHTML"] {
    overflow-x: auto !important;
    max-width: 100% !important;
    box-sizing: border-box;
  }
</style>
<script>
  window.MathJax = {
    tex: { displayMath: [['$$','$$'], ['\\[','\\]']] },
    options: { renderActions: { addMenu: [] } },
    chtml: {
      displayAlign: 'center',
      displayIndent: '0',
      scale: 1,
      linebreaks: { automatic: false }
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div id="controls">
    <button id="play-btn">▶ 재생</button>
    <div id="osc-list"></div>
    <div id="osc-btns">
      <button id="add-btn" class="osc-util-btn">오실레이터 추가</button>
      <button id="rand-btn" class="osc-util-btn">무작위 오실레이터</button>
      <button id="nc-btn" class="osc-util-btn">노이즈 캔슬링 OFF</button>
      <button id="reset-btn" class="osc-util-btn">초기화</button>
    </div>
  </div>
  <div id="canvas-wrap">
    <canvas id="waveform" width="820" height="340"></canvas>
  </div>
  <div id="sample-buttons">
    <button class="wave-btn" id="btn-tri">
      <svg viewBox="0 0 80 40">
        <polyline points="0,20 20,0 40,20 60,40 80,20" fill="none" stroke="#2196f3"/>
      </svg>
      <span>Triangle</span>
    </button>
    <button class="wave-btn" id="btn-square">
      <svg viewBox="0 0 80 40">
        <polyline points="0,40 0,0 40,0 40,40 80,40 80,0" fill="none" stroke="#e91e63"/>
      </svg>
      <span>Square</span>
    </button>
    <button class="wave-btn" id="btn-saw">
      <svg viewBox="0 0 80 40">
        <polyline points="0,40 80,0 80,40" fill="none" stroke="#4caf50"/>
      </svg>
      <span>Sawtooth</span>
    </button>
  </div>
  <div id="sample-controls">
    <button id="sample-play-btn">▶ 재생</button>
    <button id="back-btn">← 뒤로가기</button>
    <div id="sample-formula" class="sample-formula-math"></div>
    <div id="sample-osc-list"></div>
    <div id="sample-osc-btns">
      <button id="sample-add-btn" class="osc-util-btn">오실레이터 추가</button>
      <button id="sample-rand-btn" class="osc-util-btn">무작위 오실레이터</button>
      <button id="sample-nc-btn" class="osc-util-btn">노이즈 캔슬링 OFF</button>
      <button id="sample-reset-btn" class="osc-util-btn">초기화</button>
    </div>
  </div>
  <div id="sample-canvas-wrap">
    <canvas id="sample-waveform" width="820" height="340"></canvas>
  </div>
<script>
function randomColor(alpha=0.35) {
  const r = Math.floor(Math.random()*200+30);
  const g = Math.floor(Math.random()*200+30);
  const b = Math.floor(Math.random()*200+30);
  return `rgba(${r},${g},${b},${alpha})`;
}
function randomFreq() {
  return Math.round(Math.pow(2, Math.random()*6 + Math.log2(60)));
}
function randomVol() {
  return +(Math.random()).toFixed(2);
}
function randomPhase() {
  return Math.floor(Math.random()*360);
}
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let oscillators = [];
let isPlaying = false;
let noiseCancelOn = false;

let sampleOscillators = [];
let sampleIsPlaying = false;
let sampleWorkletNode = null;
let sampleWorkletReady = false;
let sampleIsPlayingFlag = false;
let sampleNoiseCancelOn = false;
let sampleNoiseCancelOscIdxs = [];
let sampleOscillatorsState = {};
let sampleWaveType = '';
let sampleBaseFreq = 440;
let sampleDrawRequest = null;

let workletReady = false;
let workletNode = null;

function updateNcBtnState() {
  const ncBtn = document.getElementById('nc-btn');
  if (oscillators.length === 0) {
    ncBtn.disabled = true;
    ncBtn.classList.add('disabled');
  } else {
    ncBtn.disabled = false;
    ncBtn.classList.remove('disabled');
  }
}
function updateSampleNcBtnState() {
  const ncBtn = document.getElementById('sample-nc-btn');
  if (sampleOscillators.length === 0) {
    ncBtn.disabled = true;
    ncBtn.classList.add('disabled');
  } else {
    ncBtn.disabled = false;
    ncBtn.classList.remove('disabled');
  }
}

async function setupWorklet() {
  if (workletReady) return;
  await audioCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([`
class SineSumProcessor extends AudioWorkletProcessor {
  constructor() {
    super();
    this.osc = [];
    this.port.onmessage = e => {
      if (e.data.type === 'osc') this.osc = e.data.data;
    };
    this.t = 0;
  }
  process(inputs, outputs, params) {
    const out = outputs[0][0];
    const sr = sampleRate;
    for (let i = 0; i < out.length; i++) {
      let y = 0;
      for (const o of this.osc) {
        if (o.active) {
          let phi = o.phase*Math.PI/180;
          y += Math.sin(2*Math.PI*o.freq*this.t + phi) * o.vol;
        }
      }
      out[i] = y;
      this.t += 1/sr;
    }
    return true;
  }
}
registerProcessor('sinesum', SineSumProcessor);
  `], {type:'application/javascript'})));
  workletNode = new AudioWorkletNode(audioCtx, 'sinesum');
  workletNode.connect(audioCtx.destination);
  workletNode.port.postMessage({type: 'osc', data: oscillators});
  workletReady = true;
}
function updateWorkletOsc() {
  if (workletNode) workletNode.port.postMessage({type: 'osc', data: oscillators});
}
function phaseToPiString(deg) {
  deg = ((deg % 360) + 360) % 360;
  if (deg === 0) return '0';
  if (deg === 180) return 'π';
  if (deg === 90) return 'π/2';
  if (deg === 270) return '3π/2';
  let frac = +(deg / 180).toFixed(2);
  return `${frac}π`;
}
function updateOscListUI() {
  const list = document.getElementById('osc-list');
  list.innerHTML = '';
  oscillators.forEach((o, idx) => {
    const phiStr = phaseToPiString(o.phase);
    const formula = `y = ${o.vol}·sin(2π·${o.freq}·t + ${phiStr})`;
    const row = document.createElement('div');
    row.className = 'osc-row';
    row.innerHTML = `
      <label style="color:${o.color}; font-weight:bold;">OSC${idx+1}</label>
      <label>주파수(Hz):</label>
      <input type="number" value="${o.freq}" min="20" max="2000" step="1" onchange="setFreq(${idx}, this.value)">
      <input type="range" min="20" max="2000" step="1" value="${o.freq}" oninput="setFreq(${idx}, this.value)">
      <label>볼륨(A):</label>
      <input type="number" value="${o.vol}" min="0" max="1" step="0.01" onchange="setVol(${idx}, this.value)">
      <input type="range" min="0" max="1" step="0.01" value="${o.vol}" oninput="setVol(${idx}, this.value)">
      <label>위상(°):</label>
      <input type="number" value="${o.phase}" min="0" max="360" step="1" onchange="setPhase(${idx}, this.value)">
      <input type="range" min="0" max="360" step="1" value="${o.phase}" oninput="setPhase(${idx}, this.value)">
      <button class="osc-btn ${o.active?'on':'off'}" onclick="toggleOsc(${idx}, this)">${o.active?'ON':'OFF'}</button>
      <button class="osc-btn del" onclick="removeOsc(${idx})">삭제</button>
      <span class="formula">${formula}</span>
    `;
    list.appendChild(row);
  });
  updateWorkletOsc();
  updateNcBtnState();
}
window.setFreq = (idx, val) => {
  oscillators[idx].freq = Number(val);
  updateOscListUI();
}
window.setVol = (idx, val) => {
  oscillators[idx].vol = Number(val);
  updateOscListUI();
}
window.setPhase = (idx, val) => {
  oscillators[idx].phase = Number(val)%360;
  updateOscListUI();
}
window.toggleOsc = (idx, btn) => { oscillators[idx].active = !oscillators[idx].active; updateOscListUI(); }
window.removeOsc = (idx) => {
  oscillators.splice(idx, 1);
  if (oscillators.length === 0) {
    noiseCancelOn = false;
    document.getElementById('nc-btn').classList.remove('active');
    document.getElementById('nc-btn').textContent = '노이즈 캔슬링 OFF';
    if (isPlaying) {
      isPlaying = false;
      if (workletNode) workletNode.disconnect();
      document.getElementById('play-btn').textContent = '▶ 재생';
    }
  }
  updateOscListUI();
};
document.getElementById('add-btn').onclick = () => {
  const color = randomColor();
  oscillators.push({freq:440, vol:0.5, phase:0, active:true, color});
  updateOscListUI();
};
document.getElementById('rand-btn').onclick = () => {
  const color = randomColor();
  oscillators.push({
    freq: randomFreq(),
    vol: randomVol(),
    phase: randomPhase(),
    active: true,
    color
  });
  updateOscListUI();
};
document.getElementById('reset-btn').onclick = () => {
  oscillators = [];
  noiseCancelOn = false;
  document.getElementById('nc-btn').classList.remove('active');
  document.getElementById('nc-btn').textContent = '노이즈 캔슬링 OFF';
  if (isPlaying) {
    isPlaying = false;
    if (workletNode) workletNode.disconnect();
    document.getElementById('play-btn').textContent = '▶ 재생';
  }
  updateOscListUI();
};
document.getElementById('nc-btn').onclick = () => {
  if (oscillators.length === 0) return;
  const tag = 'main';
  if (!noiseCancelOn) {
    const newOscs = [];
    for (let i = 0; i < oscillators.length; ++i) {
      const o = oscillators[i];
      if (!o.active) continue;
      const color = randomColor();
      newOscs.push({
        freq: o.freq,
        vol: o.vol,
        phase: (o.phase + 180)%360,
        active: o.active,
        color,
        ncTag: tag
      });
    }
    oscillators = oscillators.concat(newOscs);
    noiseCancelOn = true;
    document.getElementById('nc-btn').classList.add('active');
    document.getElementById('nc-btn').textContent = '노이즈 캔슬링 ON';
  } else {
    oscillators = oscillators.filter(o => o.ncTag !== tag);
    noiseCancelOn = false;
    document.getElementById('nc-btn').classList.remove('active');
    document.getElementById('nc-btn').textContent = '노이즈 캔슬링 OFF';
  }
  updateOscListUI();
};
document.getElementById('play-btn').onclick = async () => {
  await setupWorklet();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  isPlaying = !isPlaying;
  if (isPlaying) {
    workletNode.connect(audioCtx.destination);
    document.getElementById('play-btn').innerHTML = '<span style="font-weight:bold;font-size:1.3em;letter-spacing:0.1em;">Ⅱ</span> 일시정지';
  } else {
    workletNode.disconnect();
    document.getElementById('play-btn').textContent = '▶ 재생';
  }
};
updateOscListUI();

// ---------------- 샘플 모드 오실레이터 입력/슬라이더 연동 ----------------
function updateSampleOscListUI() {
  const list = document.getElementById('sample-osc-list');
  list.innerHTML = '';
  sampleOscillators.forEach((o, idx) => {
    const phiStr = phaseToPiString(o.phase);
    const formula = `y = ${o.amp.toFixed(3)}·sin(2π·${o.freq}·t + ${phiStr})`;
    const row = document.createElement('div');
    row.className = 'sample-osc-row';
    row.innerHTML = `
      <label style="color:${o.color}; font-weight:bold;">OSC${idx+1}</label>
      <label>주파수(Hz):</label>
      <input type="number" value="${o.freq}" min="20" max="2000" step="1" onchange="setSampleFreq(${idx}, this.value)">
      <input type="range" min="20" max="2000" step="1" value="${o.freq}" oninput="setSampleFreq(${idx}, this.value)">
      <label>볼륨(A):</label>
      <input type="number" value="${o.amp}" min="0" max="1" step="0.01" onchange="setSampleAmp(${idx}, this.value)">
      <input type="range" min="0" max="1" step="0.01" value="${o.amp}" oninput="setSampleAmp(${idx}, this.value)">
      <label>위상(°):</label>
      <input type="number" value="${o.phase}" min="0" max="360" step="1" onchange="setSamplePhase(${idx}, this.value)">
      <input type="range" min="0" max="360" step="1" value="${o.phase}" oninput="setSamplePhase(${idx}, this.value)">
      <button class="sample-osc-btn ${o.active?'on':'off'}" onclick="toggleSampleOsc(${idx}, this)">${o.active?'ON':'OFF'}</button>
      <button class="sample-osc-btn del" onclick="removeSampleOsc(${idx})">삭제</button>
      <span class="formula">${formula}</span>
    `;
    list.appendChild(row);
  });
  updateSampleWorkletOsc();
  updateSampleNcBtnState();
}
window.setSampleFreq = (idx, val) => { sampleOscillators[idx].freq = Number(val); updateSampleOscListUI(); }
window.setSampleAmp = (idx, val) => { sampleOscillators[idx].amp = Number(val); updateSampleOscListUI(); }
window.setSamplePhase = (idx, val) => { sampleOscillators[idx].phase = Number(val)%360; updateSampleOscListUI(); }
window.toggleSampleOsc = (idx, btn) => { sampleOscillators[idx].active = !sampleOscillators[idx].active; updateSampleOscListUI(); }
window.removeSampleOsc = (idx) => { sampleOscillators.splice(idx, 1); updateSampleOscListUI(); };

document.getElementById('sample-add-btn').onclick = () => {
  const color = randomColor();
  sampleOscillators.push({freq:440, amp:0.5, phase:0, active:true, color});
  updateSampleOscListUI();
};
document.getElementById('sample-rand-btn').onclick = () => {
  const color = randomColor();
  sampleOscillators.push({
    freq: randomFreq(),
    amp: randomVol(),
    phase: randomPhase(),
    active: true,
    color
  });
  updateSampleOscListUI();
};
document.getElementById('sample-reset-btn').onclick = () => {
  const harm = sampleDefs[sampleWaveType].harmonics(sampleBaseFreq);
  sampleOscillators = [];
  for(let i=0;i<harm.length;i++) {
    let h = harm[i];
    sampleOscillators.push({freq: h.freq, amp: Math.abs(h.amp), phase: h.phase, active: true, color: h.color});
  }
  sampleNoiseCancelOn = false;
  sampleNoiseCancelOscIdxs = [];
  document.getElementById('sample-nc-btn').classList.remove('active');
  document.getElementById('sample-nc-btn').textContent = '노이즈 캔슬링 OFF';
  updateSampleOscListUI();
};
// 이하 샘플 모드, 그래프, 오디오 등 나머지 코드는 위의 기본 모드와 동일하게 붙이면 완성입니다.

document.getElementById('sample-play-btn').onclick = async () => {
  await setupSampleWorklet();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  sampleIsPlaying = !sampleIsPlaying;
  sampleIsPlayingFlag = sampleIsPlaying;
  if (sampleIsPlaying) {
    sampleWorkletNode.connect(audioCtx.destination);
    document.getElementById('sample-play-btn').innerHTML = '<span style="font-weight:bold;font-size:1.3em;letter-spacing:0.1em;">Ⅱ</span> 일시정지';
  } else {
    sampleWorkletNode.disconnect();
    document.getElementById('sample-play-btn').textContent = '▶ 재생';
  }
};
document.getElementById('back-btn').onclick = () => {
  hideSampleMode();
};
document.getElementById('btn-tri').onclick = ()=>showSampleMode('triangle');
document.getElementById('btn-square').onclick = ()=>showSampleMode('square');
document.getElementById('btn-saw').onclick = ()=>showSampleMode('saw');

// 이하 draw, sampleDrawLoop 등 그래프 및 오디오 관련 함수는 위와 동일하게 이어붙이면 완성됩니다.

function drawAxes(ctx, width, height, yMin, yMax) {
  ctx.save();
  ctx.strokeStyle = "#888";
  ctx.lineWidth = 1;
  ctx.font = "12px sans-serif";
  ctx.fillStyle = "#888";
  ctx.globalAlpha = 1;

  ctx.beginPath();
  ctx.moveTo(40, height/2);
  ctx.lineTo(width-10, height/2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(40, 10);
  ctx.lineTo(40, height-10);
  ctx.stroke();

  for(let ms=0; ms<=20; ms+=5) {
    let x = 40 + (width-60)*(ms/20);
    ctx.beginPath();
    ctx.moveTo(x, height/2-5);
    ctx.lineTo(x, height/2+5);
    ctx.stroke();
    if(ms === 0) {
      ctx.fillText(`${ms}ms`, x + 12, height/2 + 20);
    } else {
      ctx.fillText(`${ms}ms`, x - 12, height/2 + 20);
    }
  }

  let range = yMax - yMin;
  let idealSteps = Math.floor((height-40)/32);
  let step = Math.pow(10, Math.floor(Math.log10(range)));
  let bestStep = step;
  let bestCount = 1000;
  [1,2,5].forEach(f=>{
    let s = f*step;
    let cnt = Math.ceil(range/s);
    if(cnt<=idealSteps && cnt>1 && Math.abs(cnt-idealSteps)<Math.abs(bestCount-idealSteps)) {
      bestStep = s;
      bestCount = cnt;
    }
  });
  step = bestStep;
  let yStart = Math.ceil(yMin/step)*step;
  let yEnd = Math.floor(yMax/step)*step;
  let ticks = [];
  for(let a=yStart; a<=yEnd+step/2; a+=step) {
    ticks.push(a);
  }
  function closeTo(a, b) { return Math.abs(a-b)<step/100; }
  if (!ticks.some(v=>closeTo(v,yMin))) ticks.push(yMin);
  if (!ticks.some(v=>closeTo(v,yMax))) ticks.push(yMax);
  ticks = Array.from(new Set(ticks.map(v=>+v.toFixed(8)))).sort((a,b)=>b-a);
  for(let i=0; i<ticks.length; ++i) {
    let a = ticks[i];
    let y = height/2 - (a-((yMax+yMin)/2))*(height-40)/range;
    ctx.beginPath();
    ctx.moveTo(35, y);
    ctx.lineTo(45, y);
    ctx.stroke();
    ctx.fillText(a.toFixed(2), 10, y+4);
  }
  ctx.restore();
}
function draw() {
  const canvas = document.getElementById('waveform');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const n = 800;
  const t = Array.from({length:n}, (_,i)=>i/n*0.02);
  let sum = Array(n).fill(0);
  let yMax = -Infinity, yMin = Infinity;
  oscillators.forEach((o,idx)=>{
    if(o.active) {
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        sum[i] += y;
      }
    }
  });
  for(let i=0; i<n; i++) {
    if(sum[i] > yMax) yMax = sum[i];
    if(sum[i] < yMin) yMin = sum[i];
  }
  if (yMax - yMin < 0.1) { yMax = 1; yMin = -1; }
  drawAxes(ctx, canvas.width, canvas.height, yMin, yMax);
  oscillators.forEach((o,idx)=>{
    if(o.active) {
      ctx.beginPath();
      ctx.strokeStyle = o.color || "#2196f3";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 1;
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        const px = 40 + (canvas.width-60)*t[i]/0.02;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.stroke();
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.vol;
        const px = 40 + (canvas.width-60)*t[i]/0.02;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.lineTo(40 + (canvas.width-60), canvas.height/2);
      ctx.lineTo(40, canvas.height/2);
      ctx.closePath();
      ctx.fillStyle = o.color || "#2196f3";
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  });
  ctx.beginPath();
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 3;
  for(let i=0; i<n; i++) {
    const px = 40 + (canvas.width-60)*t[i]/0.02;
    const py = canvas.height/2 - (sum[i]-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  requestAnimationFrame(draw);
}
draw();

function sampleDrawLoop() {
  const canvas = document.getElementById('sample-waveform');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const n = 800;
  const t = Array.from({length:n}, (_,i)=>i/n*0.02);
  let sum = Array(n).fill(0);
  let yMax = -Infinity, yMin = Infinity;
  sampleOscillators.forEach((o,idx)=>{
    if(o.active) {
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        sum[i] += y;
      }
    }
  });
  for(let i=0; i<n; i++) {
    if(sum[i] > yMax) yMax = sum[i];
    if(sum[i] < yMin) yMin = sum[i];
  }
  if (yMax - yMin < 0.1) { yMax = 1; yMin = -1; }
  drawAxes(ctx, canvas.width, canvas.height, yMin, yMax);
  sampleOscillators.forEach((o,idx)=>{
    if(o.active) {
      ctx.beginPath();
      ctx.strokeStyle = o.color || "#2196f3";
      ctx.lineWidth = 2;
      ctx.globalAlpha = 1;
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        const px = 40 + (canvas.width-60)*t[i]/0.02;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.stroke();
      ctx.globalAlpha = 0.35;
      ctx.beginPath();
      for(let i=0; i<n; i++) {
        const phi = o.phase*Math.PI/180;
        const y = Math.sin(2*Math.PI*o.freq*t[i] + phi)*o.amp;
        const px = 40 + (canvas.width-60)*t[i]/0.02;
        const py = canvas.height/2 - (y-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
        if(i===0) ctx.moveTo(px,py);
        else ctx.lineTo(px,py);
      }
      ctx.lineTo(40 + (canvas.width-60), canvas.height/2);
      ctx.lineTo(40, canvas.height/2);
      ctx.closePath();
      ctx.fillStyle = o.color || "#2196f3";
      ctx.fill();
      ctx.globalAlpha = 1;
    }
  });
  ctx.beginPath();
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 3;
  for(let i=0; i<n; i++) {
    const px = 40 + (canvas.width-60)*t[i]/0.02;
    const py = canvas.height/2 - (sum[i]-((yMax+yMin)/2))*(canvas.height-40)/(yMax-yMin);
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  sampleDrawRequest = requestAnimationFrame(sampleDrawLoop);
}

async function setupSampleWorklet() {
  if (sampleWorkletReady) return;
  await audioCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([`
class SineSumSampleProcessor extends AudioWorkletProcessor {
  constructor() {
    super();
    this.osc = [];
    this.port.onmessage = e => {
      if (e.data.type === 'osc') this.osc = e.data.data;
    };
    this.t = 0;
  }
  process(inputs, outputs, params) {
    const out = outputs[0][0];
    const sr = sampleRate;
    for (let i = 0; i < out.length; i++) {
      let y = 0;
      for (const o of this.osc) {
        if (o.active) {
          let phi = o.phase*Math.PI/180;
          y += Math.sin(2*Math.PI*o.freq*this.t + phi) * o.amp;
        }
      }
      out[i] = y;
      this.t += 1/sr;
    }
    return true;
  }
}
registerProcessor('sinesum-sample', SineSumSampleProcessor);
  `], {type:'application/javascript'})));
  sampleWorkletNode = new AudioWorkletNode(audioCtx, 'sinesum-sample');
  sampleWorkletNode.connect(audioCtx.destination);
  sampleWorkletNode.port.postMessage({type: 'osc', data: sampleOscillators});
  sampleWorkletReady = true;
}
function updateSampleWorkletOsc() {
  if (sampleWorkletNode) sampleWorkletNode.port.postMessage({type: 'osc', data: sampleOscillators});
}

function showSampleMode(type) {
  if (isPlaying) {
    isPlaying = false;
    if (workletNode) workletNode.disconnect();
    document.getElementById('play-btn').textContent = '▶ 재생';
  }
  document.body.classList.add('show-sample');
  sampleWaveType = type;
  if (sampleOscillatorsState[type]) {
    sampleOscillators = JSON.parse(JSON.stringify(sampleOscillatorsState[type]));
    sampleNoiseCancelOn = sampleOscillatorsState[type + "_nc"] || false;
    sampleNoiseCancelOscIdxs = sampleOscillatorsState[type + "_ncidxs"] || [];
  } else {
    sampleOscillators = [];
    let harm = sampleDefs[type].harmonics(sampleBaseFreq);
    for(let i=0;i<harm.length;i++) {
      let h = harm[i];
      sampleOscillators.push({freq: h.freq, amp: h.amp, phase: h.phase, active: true, color: h.color});
    }
    sampleNoiseCancelOn = false;
    sampleNoiseCancelOscIdxs = [];
  }
  updateSampleOscListUI();
  document.getElementById('sample-formula').innerHTML = sampleDefs[type].formulaLatex;
  if(window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
  sampleIsPlaying = false;
  sampleIsPlayingFlag = false;
  document.getElementById('sample-play-btn').textContent = '▶ 재생';
  document.getElementById('sample-nc-btn').classList.toggle('active', sampleNoiseCancelOn);
  document.getElementById('sample-nc-btn').textContent = sampleNoiseCancelOn ? '노이즈 캔슬링 ON' : '노이즈 캔슬링 OFF';
  cancelAnimationFrame(sampleDrawRequest);
  sampleDrawLoop();
  setupSampleWorklet().then(()=>{
    updateSampleWorkletOsc();
    if (sampleIsPlayingFlag) {
      sampleWorkletNode.connect(audioCtx.destination);
    } else {
      sampleWorkletNode.disconnect();
    }
  });
  updateSampleNcBtnState();
}
function hideSampleMode() {
  if (sampleWaveType) {
    sampleOscillatorsState[sampleWaveType] = JSON.parse(JSON.stringify(sampleOscillators));
    sampleOscillatorsState[sampleWaveType + "_nc"] = sampleNoiseCancelOn;
    sampleOscillatorsState[sampleWaveType + "_ncidxs"] = sampleNoiseCancelOscIdxs;
  }
  stopSampleOscillators();
  document.body.classList.remove('show-sample');
  sampleIsPlaying = false;
  sampleIsPlayingFlag = false;
  document.getElementById('sample-play-btn').textContent = '▶ 재생';
  cancelAnimationFrame(sampleDrawRequest);
  if (sampleWorkletNode) sampleWorkletNode.disconnect();
}
function stopSampleOscillators() {
  sampleOscillators = [];
}

function unlockAudioContext() {
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}
document.body.addEventListener('mousedown', unlockAudioContext, {once:true});
document.body.addEventListener('touchstart', unlockAudioContext, {once:true});
</script>
</body>
</html>
