<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>실시간 합성파 생성기</title>
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    #controls, #sample-controls { background: #fff; padding: 20px; border-bottom: 1px solid #ddd; }
    #osc-list, #sample-osc-list { margin-bottom: 10px; }
    .osc-row, .sample-osc-row { margin-bottom: 8px; }
    .osc-row input[type="number"], .sample-osc-row input[type="number"] { width: 70px; }
    .osc-row input[type="range"], .sample-osc-row input[type="range"] { 
      width: 120px; 
      margin: 0 8px; 
      vertical-align: middle; 
      touch-action: none;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      outline: none;
    }
    .osc-row input[type="range"]::-webkit-slider-thumb, .sample-osc-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #2196f3;
      cursor: pointer;
      border: none;
    }
    .osc-row label, .sample-osc-row label { margin-right: 5px; }
    .osc-row button, .sample-osc-row button { margin-left: 10px; }
    .osc-btn, .sample-osc-btn {
      display: inline-block;
      min-width: 60px;
      min-height: 36px;
      padding: 0 16px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      margin-left: 10px;
      vertical-align: middle;
      cursor: pointer;
      transition: background 0.15s;
    }
    .on { background: #4caf50; color: #fff; }
    .off { background: #eee; color: #444; }
    .del { background: #e53935; color: #fff; }
    #play-btn, #sample-play-btn, #back-btn, .osc-util-btn {
      font-size: 1.2em; padding: 0.7em 2em; border: none; border-radius: 8px;
      background: #2196f3; color: #fff; margin-bottom: 1em; cursor: pointer;
      margin-right: 1em;
    }
    .osc-util-btn { background: #eee; color: #222; font-size: 1em; margin-right: 0.7em; }
    .osc-util-btn.active { background: #ff9800; color: #fff; }
    .osc-util-btn:disabled,
    .osc-util-btn.disabled {
      background: #bbb !important;
      color: #fff !important;
      cursor: not-allowed !important;
      opacity: 1 !important;
    }
    .formula {
      font-size: 1em;
      margin-left: 1.5em;
      color: #333;
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      background: #f6f6f6;
      border-radius: 6px;
      padding: 2px 8px;
      display: inline-block;
    }
    #canvas-wrap, #sample-canvas-wrap {
      text-align: center;
      margin: 0 auto;
      background: #fff;
      width: 100%;
      max-width: 900px;
      box-sizing: border-box;
    }
    canvas {
      border: 1px solid #bbb;
      background: #fafafa;
      margin: 20px auto;
      display: block;
      max-width: 100%;
      box-sizing: border-box;
    }
    #sample-buttons {
      display: flex; gap: 20px; justify-content: center; margin: 36px 0 24px 0;
      flex-wrap: wrap;
    }
    .wave-btn {
      border: 2px solid #aaa; border-radius: 12px; background: #fff; cursor: pointer;
      width: 120px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 2px 8px #0001; transition: box-shadow .2s;
    }
    .wave-btn:hover { box-shadow: 0 4px 16px #0002; border-color: #2196f3; }
    .wave-btn svg { width: 80px; height: 40px; margin-bottom: 8px; }
    .wave-btn span { font-size: 1.1em; margin-top: 2px; }
    .wave-btn svg polyline { stroke-width: 4px !important; }
    #sample-controls, #sample-canvas-wrap {
      visibility: hidden; position: absolute; left: -9999px;
    }
    #controls, #canvas-wrap, #sample-buttons {
      visibility: visible; position: static;
    }
    .show-sample #sample-controls, .show-sample #sample-canvas-wrap {
      visibility: visible !important; position: static !important;
    }
    .show-sample #controls, .show-sample #canvas-wrap, .show-sample #sample-buttons {
      visibility: hidden !important; position: absolute !important; left: -9999px !important;
    }
    #sample-osc-list { margin-top: 8px; }
    #back-btn { background: #888; color: #fff; margin-left: 0; }
    .sample-formula-math {
      background: #f6f6f6;
      border-radius: 8px;
      padding: 18px 18px 12px 18px;
      margin: 16px auto 10px auto;
      font-size: 1.15em;
      max-width: 98vw;
      box-sizing: border-box;
      overflow-x: auto;
      white-space: nowrap;
      text-align: left;
    }
    .sample-formula-math h3 {
      margin: 0 0 8px 0;
      font-size: 1.12em;
      font-weight: bold;
      color: #333;
    }
    .mjx-container[jax="CHTML"] {
      overflow-x: auto !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }
    @media (max-width: 768px) {
      .osc-row, .sample-osc-row {
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .osc-row input[type="range"], .sample-osc-row input[type="range"] {
        width: 90%;
        margin: 8px 0;
      }
      .formula {
        margin-left: 0;
        margin-top: 8px;
      }
      .osc-btn, .sample-osc-btn {
        margin: 5px 5px 5px 0;
      }
    }
  </style>
  <script>
    window.MathJax = {
      tex: { displayMath: [['$$','$$'], ['\\[','\\]']] },
      options: { renderActions: { addMenu: [] } },
      chtml: {
        displayAlign: 'center',
        displayIndent: '0',
        scale: 1,
        linebreaks: { automatic: false }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
  <div id="controls">
    <button id="play-btn">▶ 재생</button>
    <div id="osc-list"></div>
    <div id="osc-btns">
      <button id="add-btn" class="osc-util-btn">오실레이터 추가</button>
      <button id="rand-btn" class="osc-util-btn">무작위 오실레이터</button>
      <button id="nc-btn" class="osc-util-btn">노이즈 캔슬링 OFF</button>
      <button id="reset-btn" class="osc-util-btn">초기화</button>
    </div>
  </div>
  <div id="canvas-wrap">
    <canvas id="waveform" width="820" height="340"></canvas>
  </div>
  <div id="sample-buttons">
    <button class="wave-btn" id="btn-tri">
      <svg viewBox="0 0 80 40">
        <polyline points="0,20 20,0 40,20 60,40 80,20" fill="none" stroke="#2196f3" stroke-width="4"/>
      </svg>
      <span>Triangle</span>
    </button>
    <button class="wave-btn" id="btn-square">
      <svg viewBox="0 0 80 40">
        <polyline points="0,40 0,0 40,0 40,40 80,40 80,0" fill="none" stroke="#e91e63" stroke-width="4"/>
      </svg>
      <span>Square</span>
    </button>
    <button class="wave-btn" id="btn-saw">
      <svg viewBox="0 0 80 40">
        <polyline points="0,40 80,0 80,40" fill="none" stroke="#4caf50" stroke-width="4"/>
      </svg>
      <span>Sawtooth</span>
    </button>
  </div>
  <div id="sample-controls">
    <button id="sample-play-btn">▶ 재생</button>
    <button id="back-btn">← 뒤로가기</button>
    <div id="sample-formula" class="sample-formula-math"></div>
    <div id="sample-osc-list"></div>
    <div id="sample-osc-btns">
      <button id="sample-add-btn" class="osc-util-btn">오실레이터 추가</button>
      <button id="sample-rand-btn" class="osc-util-btn">무작위 오실레이터</button>
      <button id="sample-nc-btn" class="osc-util-btn">노이즈 캔슬링 OFF</button>
      <button id="sample-reset-btn" class="osc-util-btn">초기화</button>
    </div>
  </div>
  <div id="sample-canvas-wrap">
    <canvas id="sample-waveform" width="820" height="340"></canvas>
  </div>
<script>
function randomColor(alpha=0.35) {
  const r = Math.floor(Math.random()*200+30);
  const g = Math.floor(Math.random()*200+30);
  const b = Math.floor(Math.random()*200+30);
  return `rgba(${r},${g},${b},${alpha})`;
}
function randomFreq() {
  return Math.round(Math.pow(2, Math.random()*6 + Math.log2(60)));
}
function randomVol() {
  return +(Math.random()).toFixed(2);
}
function randomPhase() {
  return Math.floor(Math.random()*360);
}

// 오디오 컨텍스트 관련 
let audioCtxStarted = false;
let audioCtx;

// 오디오 컨텍스트를 초기화하는 함수
function initAudioContext() {
  if (!audioCtxStarted) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioCtxStarted = true;
  }
  return audioCtx;
}

let oscillators = [];
let isPlaying = false;
let noiseCancelOn = false;
let sampleOscillators = [];
let sampleIsPlaying = false;
let sampleWorkletNode = null;
let sampleWorkletReady = false;
let sampleIsPlayingFlag = false;
let sampleNoiseCancelOn = false;
let sampleNoiseCancelOscIdxs = [];
let sampleOscillatorsState = {};
let sampleWaveType = '';
let sampleBaseFreq = 440;
let sampleDrawRequest = null;
let workletReady = false;
let workletNode = null;
const sampleDefs = {
  'triangle': {
    name: '삼각파 (Triangle Wave)',
    color: '#2196f3',
    N: 9,
    formulaLatex: `
<h3>삼각파 (Triangle Wave)</h3>
$$
f_{\\text{triangle}}(t) = \\frac{8}{\\pi^2} \\left[
    \\sin(2\\pi f t)
    - \\frac{1}{9} \\sin(2\\pi \\cdot 3f t)
    + \\frac{1}{25} \\sin(2\\pi \\cdot 5f t)
    - \\frac{1}{49} \\sin(2\\pi \\cdot 7f t)
    + \\frac{1}{81} \\sin(2\\pi \\cdot 9f t)
\\right]
$$
`,
    harmonics: (f) => {
      let arr = [];
      for(let n=1;n<=9;n+=2) {
        let amp = 8/(Math.PI*Math.PI)/n/n*(n%4===1?1:-1);
        arr.push({freq: n*f, amp: Math.abs(amp), phase: amp>0?0:180, color: '#2196f3'});
      }
      return arr;
    }
  },
  'square': {
    name: '사각파 (Square Wave)',
    color: '#e91e63',
    N: 9,
    formulaLatex: `
<h3>사각파 (Square Wave)</h3>
$$
f_{\\text{square}}(t) = \\frac{4}{\\pi} \\left[
    \\sin(2\\pi f t)
    + \\frac{1}{3} \\sin(2\\pi \\cdot 3f t)
    + \\frac{1}{5} \\sin(2\\pi \\cdot 5f t)
    + \\frac{1}{7} \\sin(2\\pi \\cdot 7f t)
    + \\frac{1}{9} \\sin(2\\pi \\cdot 9f t)
\\right]
$$
`,
    harmonics: (f) => {
      let arr = [];
      for(let n=1;n<=9;n+=2) {
        let amp = 4/(Math.PI*n);
        arr.push({freq: n*f, amp: Math.abs(amp), phase: amp>0?0:180, color: '#e91e63'});
      }
      return arr;
    }
  },
  'saw': {
    name: '톱니파 (Sawtooth Wave)',
    color: '#4caf50',
    N: 9,
    formulaLatex: `
<h3>톱니파 (Sawtooth Wave)</h3>
$$
f_{\\text{sawtooth}}(t) = \\frac{2}{\\pi} \\left[
    \\sin(2\\pi f t)
    - \\frac{1}{2} \\sin(2\\pi \\cdot 2f t)
    + \\frac{1}{3} \\sin(2\\pi \\cdot 3f t)
    - \\frac{1}{4} \\sin(2\\pi \\cdot 4f t)
    + \\frac{1}{5} \\sin(2\\pi \\cdot 5f t)
    - \\frac{1}{6} \\sin(2\\pi \\cdot 6f t)
    + \\frac{1}{7} \\sin(2\\pi \\cdot 7f t)
    - \\frac{1}{8} \\sin(2\\pi \\cdot 8f t)
    + \\frac{1}{9} \\sin(2\\pi \\cdot 9f t)
\\right]
$$
`,
    harmonics: (f) => {
      let arr = [];
      for(let n=1;n<=9;n++) {
        let amp = 2/(Math.PI*n)*(n%2===0?-1:1);
        arr.push({freq: n*f, amp: Math.abs(amp), phase: amp>0?0:180, color: '#4caf50'});
      }
      return arr;
    }
  }
};
function updateNcBtnState() {
  const ncBtn = document.getElementById('nc-btn');
  if (oscillators.length === 0) {
    ncBtn.disabled = true;
    ncBtn.classList.add('disabled');
  } else {
    ncBtn.disabled = false;
    ncBtn.classList.remove('disabled');
  }
}
function updateSampleNcBtnState() {
  const ncBtn = document.getElementById('sample-nc-btn');
  if (sampleOscillators.length === 0) {
    ncBtn.disabled = true;
    ncBtn.classList.add('disabled');
  } else {
    ncBtn.disabled = false;
    ncBtn.classList.remove('disabled');
  }
}
function phaseToPiString(deg) {
  deg = ((deg % 360) + 360) % 360;
  if (deg === 0) return '0';
  if (deg === 180) return 'π';
  if (deg === 90) return 'π/2';
  if (deg === 270) return '3π/2';
  let frac = +(deg / 180).toFixed(2);
  return `${frac}π`;
}

// 개선된 슬라이더 처리 함수
function setupRangeInput(rangeElement, numberElement, updateFn) {
  let isDragging = false;

  // 드래그 시작
  rangeElement.addEventListener('mousedown', () => {
    isDragging = true;
  });
  rangeElement.addEventListener('touchstart', () => {
    isDragging = true;
  }, { passive: true });

  // 드래그 중
  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      updateFn(rangeElement.value);
      numberElement.value = rangeElement.value;
    }
  });
  document.addEventListener('touchmove', (e) => {
    if (isDragging) {
      updateFn(rangeElement.value);
      numberElement.value = rangeElement.value;
    }
  }, { passive: true });

  // 드래그 종료
  document.addEventListener('mouseup', () => {
    isDragging = false;
  });
  document.addEventListener('touchend', () => {
    isDragging = false;
  });

  // 직접 값 입력 처리
  numberElement.addEventListener('input', (e) => {
    updateFn(e.target.value);
    rangeElement.value = e.target.value;
  });

  // 클릭이나 탭으로 변경할 경우
  rangeElement.addEventListener('input', (e) => {
    updateFn(e.target.value);
    numberElement.value = e.target.value;
  });
}

function updateOscListUI() {
  const list = document.getElementById('osc-list');
  list.innerHTML = '';
  oscillators.forEach((o, idx) => {
    const phiStr = phaseToPiString(o.phase);
    const formula = `y = ${o.vol}·sin(2π·${o.freq}·t + ${phiStr})`;
    const row = document.createElement('div');
    row.className = 'osc-row';
    row.innerHTML = `
      <label style="color:${o.color}; font-weight:bold;">OSC${idx+1}</label>
      <label>주파수(Hz):</label>
      <input type="number" value="${o.freq}" min="20" max="2000" step="1" id="osc-freq-num-${idx}">
      <input type="range" min="20" max="2000" step="1" value="${o.freq}" id="osc-freq-range-${idx}">
      <label>볼륨(A):</label>
      <input type="number" value="${o.vol}" min="0" max="1" step="0.01" id="osc-vol-num-${idx}">
      <input type="range" min="0" max="1" step="0.01" value="${o.vol}" id="osc-vol-range-${idx}">
      <label>위상(°):</label>
      <input type="number" value="${o.phase}" min="0" max="360" step="1" id="osc-phase-num-${idx}">
      <input type="range" min="0" max="360" step="1" value="${o.phase}" id="osc-phase-range-${idx}">
      <button class="osc-btn ${o.active?'on':'off'}" onclick="toggleOsc(${idx}, this)">${o.active?'ON':'OFF'}</button>
      <button class="osc-btn del" onclick="removeOsc(${idx})">삭제</button>
      <span class="formula">${formula}</span>
    `;
    list.appendChild(row);
  });
  
  oscillators.forEach((o, idx) => {
    const freqNum = document.getElementById(`osc-freq-num-${idx}`);
    const freqRange = document.getElementById(`osc-freq-range-${idx}`);
    const volNum = document.getElementById(`osc-vol-num-${idx}`);
    const volRange = document.getElementById(`osc-vol-range-${idx}`);
    const phaseNum = document.getElementById(`osc-phase-num-${idx}`);
    const phaseRange = document.getElementById(`osc-phase-range-${idx}`);
    
    if (freqNum && freqRange) {
      setupRangeInput(freqRange, freqNum, (value) => setFreq(idx, value));
    }
    if (volNum && volRange) {
      setupRangeInput(volRange, volNum, (value) => setVol(idx, value));
    }
    if (phaseNum && phaseRange) {
      setupRangeInput(phaseRange, phaseNum, (value) => setPhase(idx, value));
    }
  });
  
  updateWorkletOsc();
  updateNcBtnState();
}

window.setFreq = (idx, val) => {
  oscillators[idx].freq = Number(val);
  updateWorkletOsc();
}

window.setVol = (idx, val) => {
  oscillators[idx].vol = Number(val);
  updateWorkletOsc();
}

window.setPhase = (idx, val) => {
  oscillators[idx].phase = Number(val)%360;
  updateWorkletOsc();
}

window.toggleOsc = (idx, btn) => { 
  oscillators[idx].active = !oscillators[idx].active; 
  btn.className = `osc-btn ${oscillators[idx].active ? 'on' : 'off'}`;
  btn.textContent = oscillators[idx].active ? 'ON' : 'OFF';
  updateWorkletOsc();
}

window.removeOsc = (idx) => {
  oscillators.splice(idx, 1);
  if (oscillators.length === 0) {
    noiseCancelOn = false;
    document.getElementById('nc-btn').classList.remove('active');
    document.getElementById('nc-btn').textContent = '노이즈 캔슬링 OFF';
    if (isPlaying) {
      isPlaying = false;
      if (workletNode) workletNode.disconnect();
      document.getElementById('play-btn').textContent = '▶ 재생';
    }
  }
  updateOscListUI();
};

document.getElementById('add-btn').onclick = () => {
  initAudioContext(); // 사용자 인터랙션으로 오디오 컨텍스트 활성화
  const color = randomColor();
  oscillators.push({freq:440, vol:0.5, phase:0, active:true, color});
  updateOscListUI();
};

document.getElementById('rand-btn').onclick = () => {
  initAudioContext(); // 사용자 인터랙션으로 오디오 컨텍스트 활성화
  const color = randomColor();
  oscillators.push({
    freq: randomFreq(),
    vol: randomVol(),
    phase: randomPhase(),
    active: true,
    color
  });
  updateOscListUI();
};

document.getElementById('reset-btn').onclick = () => {
  oscillators = [];
  noiseCancelOn = false;
  document.getElementById('nc-btn').classList.remove('active');
  document.getElementById('nc-btn').textContent = '노이즈 캔슬링 OFF';
  if (isPlaying) {
    isPlaying = false;
    if (workletNode) workletNode.disconnect();
    document.getElementById('play-btn').textContent = '▶ 재생';
  }
  updateOscListUI();
};

document.getElementById('nc-btn').onclick = () => {
  initAudioContext(); // 사용자 인터랙션으로 오디오 컨텍스트 활성화
  if (oscillators.length === 0) return;
  const tag = 'main';
  if (!noiseCancelOn) {
    const newOscs = [];
    for (let i = 0; i < oscillators.length; ++i) {
      const o = oscillators[i];
      if (!o.active) continue;
      const color = randomColor();
      newOscs.push({
        freq: o.freq,
        vol: o.vol,
        phase: (o.phase + 180)%360,
        active: o.active,
        color,
        ncTag: tag
      });
    }
    oscillators = oscillators.concat(newOscs);
    noiseCancelOn = true;
    document.getElementById('nc-btn').classList.add('active');
    document.getElementById('nc-btn').textContent = '노이즈 캔슬링 ON';
  } else {
    oscillators = oscillators.filter(o => o.ncTag !== tag);
    noiseCancelOn = false;
    document.getElementById('nc-btn').classList.remove('active');
    document.getElementById('nc-btn').textContent = '노이즈 캔슬링 OFF';
  }
  updateOscListUI();
};

document.getElementById('play-btn').onclick = async () => {
  // 오디오 컨텍스트 초기화 및 활성화 시도
  initAudioContext();
  await setupWorklet();
  await forceAudioContextResume();
  
  isPlaying = !isPlaying;
  if (isPlaying) {
    workletNode.connect(audioCtx.destination);
    document.getElementById('play-btn').innerHTML = '<span style="font-weight:bold;font-size:1.3em;letter-spacing:0.1em;">Ⅱ</span> 일시정지';
  } else {
    workletNode.disconnect();
    document.getElementById('play-btn').textContent = '▶ 재생';
  }
};

function updateSampleOscListUI() {
  const list = document.getElementById('sample-osc-list');
  list.innerHTML = '';
  sampleOscillators.forEach((o, idx) => {
    const phiStr = phaseToPiString(o.phase);
    const formula = `y = ${o.amp.toFixed(3)}·sin(2π·${o.freq}·t + ${phiStr})`;
    const row = document.createElement('div');
    row.className = 'sample-osc-row';
    row.innerHTML = `
      <label style="color:${o.color}; font-weight:bold;">OSC${idx+1}</label>
      <label>주파수(Hz):</label>
      <input type="number" value="${o.freq}" min="20" max="2000" step="1" id="sample-freq-num-${idx}">
      <input type="range" min="20" max="2000" step="1" value="${o.freq}" id="sample-freq-range-${idx}">
      <label>볼륨(A):</label>
      <input type="number" value="${o.amp}" min="0" max="1" step="0.01" id="sample-amp-num-${idx}">
      <input type="range" min="0" max="1" step="0.01" value="${o.amp}" id="sample-amp-range-${idx}">
      <label>위상(°):</label>
      <input type="number" value="${o.phase}" min="0" max="360" step="1" id="sample-phase-num-${idx}">
      <input type="range" min="0" max="