<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>마이크 신호</title>
  <style>
    body { background: #222; color: #eee; font-family: sans-serif; }
    canvas { background: #111; display: block; margin: 0 auto; }
    .equations { max-width: 700px; margin: 20px auto; font-size: 1.1em; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">마이크 신호 사인파 분해 실시간 시각화</h2>
  <canvas id="canvas" width="700" height="300"></canvas>
  <div class="equations" id="eq"></div>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const eqDiv = document.getElementById('eq');
    const WIDTH = canvas.width, HEIGHT = canvas.height;
    const N = 8; // 시각화할 주요 주파수 성분 개수

    // 마이크 접근 및 오디오 분석
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);

      const bufferLength = analyser.fftSize;
      const timeData = new Float32Array(bufferLength);
      const freqData = new Float32Array(bufferLength);

      function draw() {
        analyser.getFloatTimeDomainData(timeData);
        analyser.getFloatFrequencyData(freqData);

        ctx.clearRect(0, 0, WIDTH, HEIGHT);

        // 주파수별로 N개 성분만 추출 (가장 큰 것들)
        let mags = Array.from(freqData).map((v, i) => ({ mag: Math.abs(v), idx: i }));
        mags.sort((a, b) => b.mag - a.mag);
        let top = mags.slice(0, N);

        // 각 사인파 성분 그리기 (흐리게)
        let eqs = [];
        let sumY = new Array(WIDTH).fill(0);
        for (let n = 0; n < N; n++) {
          let i = top[n].idx;
          let freq = i * audioCtx.sampleRate / analyser.fftSize;
          let amp = Math.max(0, (freqData[i] + 140) / 60); // 대략적인 진폭 정규화
          let phase = 0; // 위상은 여기선 생략
          ctx.beginPath();
          ctx.strokeStyle = `rgba(100,200,255,0.18)`;
          for (let x = 0; x < WIDTH; x++) {
            let t = x / WIDTH;
            let y = amp * Math.sin(2 * Math.PI * freq * t * 0.01 + phase);
            let plotY = HEIGHT/2 - y * HEIGHT/3;
            if (x === 0) ctx.moveTo(x, plotY);
            else ctx.lineTo(x, plotY);
            sumY[x] += y;
          }
          ctx.stroke();
          eqs.push(`A<sub>${n+1}</sub>sin(2π${freq.toFixed(1)}t)`);
        }

        // 합성 신호(모든 사인파 합) 그리기 (진하게)
        ctx.beginPath();
        ctx.strokeStyle = `rgba(255,255,0,0.95)`;
        for (let x = 0; x < WIDTH; x++) {
          let plotY = HEIGHT/2 - sumY[x] * HEIGHT/3;
          if (x === 0) ctx.moveTo(x, plotY);
          else ctx.lineTo(x, plotY);
        }
        ctx.stroke();

        // 원래 마이크 신호(시간영역)도 반투명하게 표시
        ctx.beginPath();
        ctx.strokeStyle = `rgba(255,255,255,0.2)`;
        for (let x = 0; x < WIDTH; x++) {
          let idx = Math.floor(x / WIDTH * bufferLength);
          let y = timeData[idx];
          let plotY = HEIGHT/2 - y * HEIGHT/2.2;
          if (x === 0) ctx.moveTo(x, plotY);
          else ctx.lineTo(x, plotY);
        }
        ctx.stroke();

        // 수식 표시
        eqDiv.innerHTML = `<b>합성 신호:</b> <br> y(t) = ${eqs.join(' + ')}`;

        requestAnimationFrame(draw);
      }
      draw();
    }).catch(err => {
      eqDiv.innerHTML = "마이크 접근 권한이 필요합니다.";
    });
  </script>
</body>
</html>
